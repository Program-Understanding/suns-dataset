{% extends "base.html" %}

{% block content %}

  <h1>{{ test_name }} {{ title }}</h1>

  <form id="filterForm">
    Datasets and tools
    <label>
      <input type="radio" name="filter" value="all" checked />
      all
    </label>
    <br>
    Specific Tools:
    <label>
      <input type="radio" name="filter" value="ghidra-xrefs"/>
      ghidra-xrefs
    </label>

    <label>
      <input type="radio" name="filter" value="angr-cfg"/>
      angr-cfg
    </label>

    <label>
      <input type="radio" name="filter" value="jakstab-cfg"/>
      jakstab-cfg
    </label>

    <label>
      <input type="radio" name="filter" value="sja"/>
      sja
    </label>

    <label>
      <input type="radio" name="filter" value="frigg"/>
      frigg
    </label>

    <label>
      <input type="radio" name="filter" value="rose"/>
      rose
    </label>

    <label>
      <input type="radio" name="filter" value="ooanalyzer"/>
      ooanalyzer
    </label>

    <br>
    Interesting Results:
    <label>
      <input type="radio" name="filter" value="all-tools-right"/>
      All tools got it right
    </label>
    <label>
      <input type="radio" name="filter" value="all-tools-wrong"/>
      All tools got it wrong or invalid
    </label>
    <label>
      <input type="radio" name="filter" value="one-tool-right"/>
      Only one tool got it right
    </label>
  </form>
  
  <br>
  <form action="{{ url_for('export') }}" method="POST" onsubmit="includeFilter()">
    <input type="hidden" id="exportFilterValue" name="exportFilterValue">
    <input type="hidden" id="exportRequestValue" name="exportRequestValue" value={{ request }}>
    <button type="submit">Export ALL to Excel</button>
  </form>

  
  <p></p>
  Total:<span id="span_count">unknown</span>&nbsp;&nbsp;
  Correct:<span id="span_correct" style="color:green;">unknown</span>&nbsp;&nbsp;
  Incorrect:<span id="span_incorrect" style="color:red;">unknown</span>&nbsp;&nbsp;
  Timeout:<span id="span_timeout" style="color:red;">unknown</span>&nbsp;&nbsp;
  Invalid:<span id="span_invalid" style="color:purple;">unknown</span>&nbsp;&nbsp;

  {% set ns = namespace(count = 0) %}
  <ul>

  {% for challenge in challenges | sort(attribute="name") %}

    <span id="row{{ ns.count }}">
    {% set ns.count = ns.count + 1 %}

    <li>

    
    {% if challenge.details | length > 1 %}
        <span class="toggle" onclick="toggleDetails(this)">+</span>
    {% endif %}

    {{ challenge.name }}:  {{ challenge.score}}

    {% if challenge.score == "YES" %}
    ðŸ™‚
    {% endif %}

    {% if challenge.logexists %}
        <a href= {{ "/log/" + challenge.log }} >log</a>
    {% else %}
        <span style="color: lightgray;">log not available</span>
    {% endif %}    

    <a href= {{ "/disdecomp/" + challenge.disdecomp }} >code</a>
    <div class="details">
      <ul>
      {% for ll in challenge.details %}      
        <li>{{ ll }}</li>
      {% endfor %}
      </ul>
    </div>
    </li>

    </span>
  {% endfor %}
  </ul>


  <script>
    
  function includeFilter() {
      // move data to the excel submission as needed
      const selectedValue = document.querySelector('input[name="filter"]:checked');
      console.log("moving to export ");
      console.log(selectedValue);
      if (selectedValue) {
	  document.getElementById('exportFilterValue').value = selectedValue.value;
      }
  }
    
    
  function toggleDetails(element) {
      console.log("find it")
      console.log(element)
        const details = element.nextElementSibling.nextElementSibling.nextElementSibling; // Get the next sibling (details div)
        if (details.style.display === "none" || details.style.display === "") {
            details.style.display = "block"; // Show details
            element.textContent = "-"; // Change "+" to "-"
        } else {
            details.style.display = "none"; // Hide details
            element.textContent = "+"; // Change "-" back to "+"
        }
  }


  // returns a list of all challenges for the same dataset but different tools
  function other_tool_results(name, challenges) {
      const index = name.indexOf("--")
      if (index == -1) {
	  alert("huh? expected '--' in " + name);
      }
      dataset = name.substring(0,index)
      console.log("dataset is: " + dataset)
      let results = []
      challenges.forEach(challenge => {
	  if (challenge.name.startsWith(dataset) && challenge.name != name) {
	      results.push(challenge);
	  }
      });
      return results;

  }

  
  // If you add a new filter, be sure to add support for it here
  // We also care about how many tools there are... 5 right now
  function filter_includes(challenge, filter, challenges) {

      const TOOL_COUNT = 7;

      if (filter == "all") {
	  return true;
      }
      if (filter == "ghidra-xrefs") {
	  return challenge.name.endsWith("--ghidra-xrefs-results");
      }
      if (filter == "angr-cfg") {
	  return challenge.name.endsWith("--angr-cfg-results");
      }
      if (filter == "sja") {
	  return challenge.name.endsWith("--sja-results");
      }
      if (filter == "jakstab-cfg") {
	  return challenge.name.endsWith("--jakstab-cfg-results");
      }
      if (filter == "frigg") {
	  return challenge.name.endsWith("--frigg-results");
      }
      if (filter == "rose") {
	  return challenge.name.endsWith("--rose-results");
      }
      if (filter == "ooanalyzer") {
	  return challenge.name.endsWith("--ooanalyzer-results");
      }
      
      if (filter == "all-tools-right") {
	  // our result must be correct.
	  if (challenge.score != "YES") {
	      return false;
	  }
	  // all other results with same dataset must be correct
	  others = other_tool_results(challenge.name,challenges)
	  // Taking away the requirement that we have data for ALL tools
	  //if (others.length != TOOL_COUNT-1 ) {
	  //    return false;
	  //}
	  result = true;
	  others.forEach(c => {
	      if (c.score != "YES") {
		  result = false;
		  return;
	      }
	  });
	  return result
      }

      if (filter == "all-tools-wrong") {
	  // our result must be wrong
	  if (challenge.score == "YES") {
	      return false;
	  }
	  // all other results with same dataset must be wrong or invalid
	  others = other_tool_results(challenge.name,challenges)
	  // Taking away the requirement that we have data for ALL tools
	  //if (others.length != TOOL_COUNT-1 ) {
	  //    return false;
	  //}
	  result = true;
	  others.forEach(c => {
	      if (c.score == "YES") {
		  result = false
		  return;
	      }
	  });
	  return result;
      }

      if (filter == "one-tool-right") {
	  // our results must be correct
	  if (challenge.score != "YES") {
	      return false;
	  }
	  // all other results must be wrong.
	  others = other_tool_results(challenge.name,challenges)
	  // Taking away the requirement that we have data for ALL tools
	  //if (others.length != TOOL_COUNT-1 ) {
	  //    return false;
	  //}
	  result = true;
	  others.forEach(c => {
	      if (c.score == "YES") {
		  result = false;
		  return;
	      }
	  });
	  return result;
      }

      
      
      return false;
  }

  
  function renderTotals(challenges, filter) {

      let count = 0;
      let correct = 0;
      let incorrect = 0;
      let invalid = 0;
      let timeout = 0;

      let index = 0;
      
      challenges.forEach(challenge => {

	  if (filter_includes(challenge,filter,challenges)) {

	      document.getElementById("row"+index).style.display="block"; //show it
	      console.log("show row " + index + ":" + challenge.name);
	      count = count + 1;
	      if (challenge.score == "YES") {
		  correct = correct + 1;
	      } else if (challenge.score == "NO") {
		  incorrect = incorrect + 1;
	      } else if (challenge.score == "timeout") {
		  timeout = timeout + 1;
	      } else {
		  invalid = invalid + 1;
	      }
	  } else {
	      document.getElementById("row"+index).style.display="none";
	      console.log("hide row " + index + ":" + challenge.name);
	  }
	  index = index + 1;
      });

      // now render
      document.getElementById('span_count').textContent = count;
      document.getElementById('span_correct').textContent = correct;
      document.getElementById('span_incorrect').textContent = incorrect;
      document.getElementById('span_timeout').textContent = timeout;
      document.getElementById('span_invalid').textContent = invalid;
      
  }

  const filterOptions = document.querySelectorAll('input[name="filter"]');
  const challenges = {{ challenges  | sort(attribute="name") | tojson }};
  
  filterOptions.forEach(option => {
      option.addEventListener('change',function() {
	  const selectedFilter = this.value;
	  console.log('you selected:' + selectedFilter);
	  renderTotals(challenges,selectedFilter);
	  // call function
      });
  });

  renderTotals(challenges,'all');





  

</script>


  
{% endblock content %}


